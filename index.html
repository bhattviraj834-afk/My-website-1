import { useState, useEffect } from 'react';
import { initializeApp } from 'firebase/app';
import { getAuth, createUserWithEmailAndPassword, signInWithEmailAndPassword, onAuthStateChanged, signOut, signInAnonymously } from 'firebase/auth';
import { getFirestore, doc, setDoc, getDoc, onSnapshot, collection } from 'firebase/firestore';

// YOUR FIREBASE CONFIGURATION
const firebaseConfig = {
  apiKey: "AIzaSyDIUExlm-FIAxznN5Ww4_mOeyXFtSioNa8",
  authDomain: "ncc-nu.firebaseapp.com",
  projectId: "ncc-nu",
  storageBucket: "ncc-nu.firebasestorage.app",
  messagingSenderId: "938964283399",
  appId: "1:938964283399:web:63c50a9f824b0e82503aa2"
};

const app = initializeApp(firebaseConfig);
const db = getFirestore(app);
const auth = getAuth(app);

const App = () => {
  const [user, setUser] = useState(null);
  const [loading, setLoading] = useState(true);
  const [page, setPage] = useState('home');
  const [sidebarActive, setSidebarActive] = useState(false);
  const [datetime, setDatetime] = useState('');
  const [userRole, setUserRole] = useState('');
  const [userBatch, setUserBatch] = useState('');

  const [loginEmail, setLoginEmail] = useState('');
  const [loginPassword, setLoginPassword] = useState('');
  const [signupModalOpen, setSignupModalOpen] = useState(false);
  const [signupName, setSignupName] = useState('');
  const [signupEmail, setSignupEmail] = useState('');
  const [signupPassword, setSignupPassword] = useState('');
  const [signupRePassword, setSignupRePassword] = useState('');
  const [signupRole, setSignupRole] = useState('User');
  const [signupBatch, setSignupBatch] = useState('SD 2026');

  const [cadets, setCadets] = useState({
    'SD 2026': [],
    'SD 2027': [],
    'SW 2026': [],
    'SW 2027': [],
  });

  // Authentication Listener
  useEffect(() => {
    const unsubscribe = onAuthStateChanged(auth, async (authUser) => {
      if (authUser) {
        const userDocRef = doc(db, 'users', authUser.uid);
        const userDocSnap = await getDoc(userDocRef);
        if (userDocSnap.exists()) {
          const userData = userDocSnap.data();
          setUser(userData);
          setUserRole(userData.role);
          setUserBatch(userData.batch);
        } else {
          const newUser = {
            uid: authUser.uid,
            name: 'Anonymous User',
            email: authUser.email || 'N/A',
            role: 'User',
            batch: 'N/A',
          };
          await setDoc(userDocRef, newUser);
          setUser(newUser);
        }
      } else {
        setUser(null);
        setUserRole('');
        setUserBatch('');
      }
      setLoading(false);
    });
    return () => unsubscribe();
  }, [auth, db]);

  // Real-time Cadet Data Listener
  useEffect(() => {
    if (user) {
      const cadetsRef = collection(db, 'cadets');
      const unsubscribe = onSnapshot(cadetsRef, (snapshot) => {
        const newCadets = {
          'SD 2026': [],
          'SD 2027': [],
          'SW 2026': [],
          'SW 2027': [],
        };
        snapshot.forEach((doc) => {
          const cadetData = doc.data();
          if (newCadets[cadetData.batch]) {
            newCadets[cadetData.batch].push(cadetData);
          }
        });
        setCadets(newCadets);
      });
      return () => unsubscribe();
    }
  }, [user, db]);

  // Date and Time Update
  useEffect(() => {
    const updateTime = () => {
      const now = new Date();
      setDatetime(now.toLocaleString());
    };
    const interval = setInterval(updateTime, 1000);
    updateTime();
    return () => clearInterval(interval);
  }, []);

  const handleLogin = async (e) => {
    e.preventDefault();
    try {
      await signInWithEmailAndPassword(auth, loginEmail, loginPassword);
    } catch (error) {
      alert(`Login failed: ${error.message}`);
    }
  };

  const handleSignup = async (e) => {
    e.preventDefault();
    if (signupPassword !== signupRePassword) {
      alert('Passwords do not match.');
      return;
    }
    try {
      const userCredential = await createUserWithEmailAndPassword(auth, signupEmail, signupPassword);
      const newUser = {
        uid: userCredential.user.uid,
        name: signupName,
        email: signupEmail,
        role: signupRole,
        batch: signupBatch,
      };
      const userDocRef = doc(db, 'users', newUser.uid);
      await setDoc(userDocRef, newUser);

      const cadetDocRef = doc(collection(db, 'cadets'));
      await setDoc(cadetDocRef, {
        id: cadetDocRef.id,
        name: signupName,
        regimentalNo: '',
        rollNo: '',
        batch: signupBatch,
      });

      setSignupModalOpen(false);
      alert('Account created and logged in!');
    } catch (error) {
      alert(`Signup failed: ${error.message}`);
    }
  };
  
  const handleLogout = async () => {
    await signOut(auth);
  };

  const toggleSidebar = () => {
    setSidebarActive(!sidebarActive);
  };

  const showPage = (pageName) => {
    setPage(pageName);
    setSidebarActive(false);
  };

  const getPageContent = () => {
    switch (page) {
      case 'home':
        return (
          <>
            <h1 className="text-3xl font-bold mb-4">Welcome, {user.name}!</h1>
            <p className="mb-8">Your Role: {userRole}, Batch: {userBatch}</p>
            <div className="flex flex-wrap justify-center space-x-4">
              <button onClick={() => showPage('tab1')} className="bg-blue-500 hover:bg-blue-600 text-white font-bold py-2 px-4 rounded">Tab 1</button>
              <button onClick={() => showPage('tab2')} className="bg-blue-500 hover:bg-blue-600 text-white font-bold py-2 px-4 rounded">Tab 2</button>
              <button onClick={() => showPage('tab3')} className="bg-blue-500 hover:bg-blue-600 text-white font-bold py-2 px-4 rounded">Tab 3</button>
              <button onClick={() => showPage('tab4')} className="bg-blue-500 hover:bg-blue-600 text-white font-bold py-2 px-4 rounded">Tab 4</button>
            </div>
          </>
        );
      case 'tab1':
        return <h1 className="text-2xl font-bold">This is Tab 1</h1>;
      case 'tab2':
        return <h1 className="text-2xl font-bold">This is Tab 2</h1>;
      case 'tab3':
        return (
          <div className="p-4">
            <h1 className="text-2xl font-bold mb-4">Cadet Sections</h1>
            <div className="grid grid-cols-1 md:grid-cols-2 lg:grid-cols-2 gap-4">
              {['SD 2026', 'SD 2027', 'SW 2026', 'SW 2027'].map((batch) => (
                <div key={batch} className="bg-gray-100 p-4 rounded-lg shadow-md">
                  <h3 className="text-xl font-semibold mb-2">{batch}</h3>
                  <ul className="list-disc list-inside text-left">
                    {cadets[batch].map((cadet, index) => (
                      <li key={index}>{cadet.name}</li>
                    ))}
                  </ul>
                  <button onClick={() => alert(`Add Cadet for ${batch}`)} className="mt-4 bg-green-500 hover:bg-green-600 text-white font-bold py-2 px-4 rounded-lg">Add Cadet</button>
                </div>
              ))}
            </div>
          </div>
        );
      case 'tab4':
        return <h1 className="text-2xl font-bold">This is Tab 4</h1>;
      default:
        return null;
    }
  };

  if (loading) {
    return <div className="flex items-center justify-center min-h-screen">Loading...</div>;
  }

  if (!user) {
    return (
      <div className="flex items-center justify-center min-h-screen bg-gray-100">
        <div className="w-full max-w-md p-8 space-y-6 bg-white rounded-xl shadow-lg">
          <h2 className="text-3xl font-bold text-center text-gray-900">Welcome</h2>
          <form onSubmit={handleLogin} className="space-y-4">
            <div>
              <input
                type="email"
                placeholder="Email"
                value={loginEmail}
                onChange={(e) => setLoginEmail(e.target.value)}
                className="w-full px-4 py-2 border border-gray-300 rounded-lg focus:ring-blue-500 focus:border-blue-500"
                required
              />
            </div>
            <div>
              <input
                type="password"
                placeholder="Password"
                value={loginPassword}
                onChange={(e) => setLoginPassword(e.target.value)}
                className="w-full px-4 py-2 border border-gray-300 rounded-lg focus:ring-blue-500 focus:border-blue-500"
                required
              />
            </div>
            <button type="submit" className="w-full py-2 text-white bg-blue-600 rounded-lg hover:bg-blue-700">Login</button>
          </form>
          <div className="flex items-center justify-between">
            <a href="#" className="text-sm text-blue-600 hover:underline">Forgot password?</a>
            <button onClick={() => setSignupModalOpen(true)} className="text-sm text-blue-600 hover:underline">New user? Sign up!</button>
          </div>
        </div>

        {signupModalOpen && (
          <div className="fixed inset-0 z-50 flex items-center justify-center bg-black bg-opacity-50">
            <div className="w-full max-w-md p-8 bg-white rounded-xl shadow-lg">
              <h2 className="text-2xl font-bold text-center text-gray-900">Sign Up</h2>
              <form onSubmit={handleSignup} className="mt-4 space-y-4">
                <div>
                  <input type="text" placeholder="Full Name" value={signupName} onChange={(e) => setSignupName(e.target.value)} className="w-full px-4 py-2 border rounded-lg" required />
                </div>
                <div>
                  <input type="email" placeholder="Email" value={signupEmail} onChange={(e) => setSignupEmail(e.target.value)} className="w-full px-4 py-2 border rounded-lg" required />
                </div>
                <div>
                  <input type="password" placeholder="Password" value={signupPassword} onChange={(e) => setSignupPassword(e.target.value)} className="w-full px-4 py-2 border rounded-lg" required />
                </div>
                <div>
                  <input type="password" placeholder="Re-enter Password" value={signupRePassword} onChange={(e) => setSignupRePassword(e.target.value)} className="w-full px-4 py-2 border rounded-lg" required />
                </div>
                <div>
                  <label className="block text-sm font-medium text-gray-700">Role</label>
                  <select value={signupRole} onChange={(e) => setSignupRole(e.target.value)} className="w-full px-4 py-2 border rounded-lg">
                    <option value="User">User</option>
                    <option value="Admin">Admin</option>
                    <option value="Alumni">Alumni</option>
                  </select>
                </div>
                <div>
                  <label className="block text-sm font-medium text-gray-700">Batch</label>
                  <select value={signupBatch} onChange={(e) => setSignupBatch(e.target.value)} className="w-full px-4 py-2 border rounded-lg">
                    <option value="SD 2026">SD 2026</option>
                    <option value="SD 2027">SD 2027</option>
                    <option value="SW 2026">SW 2026</option>
                    <option value="SW 2027">SW 2027</option>
                  </select>
                </div>
                <div className="flex justify-between items-center">
                  <button type="submit" className="flex-1 py-2 text-white bg-blue-600 rounded-lg hover:bg-blue-700 mr-2">Sign Up</button>
                  <button type="button" onClick={() => setSignupModalOpen(false)} className="flex-1 py-2 text-gray-700 bg-gray-200 rounded-lg hover:bg-gray-300">Cancel</button>
                </div>
              </form>
            </div>
          </div>
        )}
      </div>
    );
  }

  return (
    <div className="flex min-h-screen bg-gray-50">
      <div className={`fixed inset-y-0 left-0 z-50 transform ${sidebarActive ? 'translate-x-0' : '-translate-x-full'} md:relative md:translate-x-0 transition-transform duration-300 ease-in-out bg-gray-800 text-white w-64 p-4 shadow-lg`}>
        <div className="flex items-center justify-between mb-8">
          <h1 className="text-xl font-bold">My Website</h1>
          <button onClick={toggleSidebar} className="text-2xl md:hidden">&times;</button>
        </div>
        <div className="mb-8">
          <p className="text-sm">Logged in as:</p>
          <h2 className="text-lg font-semibold">{user.name}</h2>
          <p className="text-xs text-gray-400">({user.email})</p>
          <button onClick={handleLogout} className="mt-2 text-xs bg-red-500 hover:bg-red-600 text-white py-1 px-2 rounded-lg">Logout</button>
        </div>
        <nav className="space-y-2">
          <a onClick={() => showPage('home')} className="block py-2.5 px-4 rounded-lg transition duration-200 hover:bg-gray-700 hover:text-white cursor-pointer">Home</a>
          <a onClick={() => showPage('tab1')} className="block py-2.5 px-4 rounded-lg transition duration-200 hover:bg-gray-700 hover:text-white cursor-pointer">Tab 1</a>
          <a onClick={() => showPage('tab2')} className="block py-2.5 px-4 rounded-lg transition duration-200 hover:bg-gray-700 hover:text-white cursor-pointer">Tab 2</a>
          <a onClick={() => showPage('tab3')} className="block py-2.5 px-4 rounded-lg transition duration-200 hover:bg-gray-700 hover:text-white cursor-pointer">Tab 3</a>
          <a onClick={() => showPage('tab4')} className="block py-2.5 px-4 rounded-lg transition duration-200 hover:bg-gray-700 hover:text-white cursor-pointer">Tab 4</a>
        </nav>
      </div>
      <div className="flex-1 transition-all duration-300 ease-in-out p-4">
        <header className="flex items-center p-4 bg-white shadow-md rounded-lg mb-4">
          <button onClick={toggleSidebar} className="text-gray-600 text-2xl mr-4 md:hidden">☰</button>
          <h1 className="text-xl font-semibold flex-1 text-center">My Website</h1>
        </header>
        <main className="bg-white p-6 rounded-lg shadow-md">
          {getPageContent()}
        </main>
      </div>
    </div>
  );
};

export default App;
